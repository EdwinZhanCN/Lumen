name: CI Build

on:
    push:
        branches: [main]
    pull_request:
        branches: [main, dev]

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install build tools
              run: pip install build setuptools_scm

            - name: Build all packages
              run: |
                  for pkg in lumen-clip lumen-resources lumen-face lumen-ocr; do
                    echo "Building $pkg..."
                    cd $pkg
                    python -m build --outdir ../dist
                    cd ..
                  done

            - name: List built packages
              run: |
                  echo "Built packages:"
                  ls -la dist/

    test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install dependencies
              run: |
                  # Install each package in development mode for testing
                  for pkg in lumen-clip lumen-resources lumen-face lumen-ocr; do
                    echo "Installing $pkg..."
                    cd $pkg
                    pip install -e .
                    cd ..
                  done

            - name: Test imports
              run: |
                  # Test that all packages can be imported
                  python -c "
                  import sys
                  for pkg in ['lumen_clip', 'lumen_face', 'lumen_ocr', 'lumen_resources']:
                      try:
                          __import__(pkg)
                          print(f'✓ {pkg} imported successfully')
                      except ImportError as e:
                          print(f'✗ {pkg} import failed: {e}')
                          sys.exit(1)
                  "
