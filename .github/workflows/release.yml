name: Release Packages

on:
    push:
        branches: [dev] # 只在 dev 分支触发自动发布
        tags: ["v*"] # tag 触发正式发布

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install build tools
              run: pip install build setuptools_scm

            - name: Get version from root
              run: |
                  # Get version from project root
                  python -c "
                  import setuptools_scm
                  try:
                      version = setuptools_scm.get_version()
                      print(f'Version found: {version}')
                      with open('version.txt', 'w') as f:
                          f.write(version)
                  except Exception as e:
                      print(f'Error getting version: {e}')
                      with open('version.txt', 'w') as f:
                          f.write('0.0.0')
                  "

                  # Show the version and set environment variable
                  if [ -f version.txt ]; then
                    VERSION=$(cat version.txt)
                    echo "Version determined: $VERSION"
                    echo "VERSION=$VERSION" >> $GITHUB_ENV
                  else
                    echo "Failed to determine version"
                    echo "VERSION=0.0.0" >> $GITHUB_ENV
                  fi

            - name: Build all packages
              run: |
                  for pkg in lumen-clip lumen-resources lumen-face lumen-ocr; do
                    echo "Building $pkg..."
                    cd $pkg
                    python -m build --outdir ../dist
                    cd ..
                  done

            - name: Create Release
              if: startsWith(github.ref, 'refs/tags/')
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ github.ref_name }}
                  release_name: Release ${{ github.ref_name }}
                  draft: false
                  prerelease: false
                  files: dist/*.whl

            - name: Create Dev Release
              if: github.ref == 'refs/heads/dev'
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: v${{ env.VERSION }}-dev
                  release_name: Dev Release ${{ env.VERSION }}
                  draft: false
                  prerelease: true
                  files: dist/*.whl
