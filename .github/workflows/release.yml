name: Release Packages

on:
    push:
        tags: ["v*"] # Only trigger on version tags

jobs:
    pypi-publish:
        name: Build and Publish
        runs-on: ubuntu-latest
        permissions:
            contents: write # For creating GitHub Release
            id-token: write # For PyPI trusted publishing (optional)

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install build tools
              run: pip install build twine setuptools_scm

            - name: Get version
              id: get_version
              run: |
                  # Get version from tag (e.g., v0.2.0 -> 0.2.0)
                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "Version determined from tag: $VERSION"
                  echo "VERSION=$VERSION" >> $GITHUB_ENV

            # 1. Build and Publish lumen-resources to PyPI
            - name: Build and Publish lumen-resources
              env:
                  TWINE_USERNAME: __token__
                  TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
                  SETUPTOOLS_SCM_PRETEND_VERSION: ${{ env.VERSION }}
              run: |
                  echo "ðŸ“¦ Building and Publishing lumen-resources..."
                  cd lumen-resources
                  python -m build --outdir ../dist
                  twine upload ../dist/lumen_resources-*.whl ../dist/lumen_resources-*.tar.gz
                  cd ..

            # 2. Build other packages (lumen-clip, etc.) ONLY for GitHub Release
            # We do NOT upload these to PyPI, but we build wheels so users can download them from GitHub.
            - name: Build other packages
              env:
                  SETUPTOOLS_SCM_PRETEND_VERSION: ${{ env.VERSION }}
              run: |
                  for pkg in lumen-clip lumen-face lumen-ocr; do
                    echo "ðŸ“¦ Building $pkg (GitHub Release only)..."
                    cd $pkg
                    python -m build --outdir ../dist
                    cd ..
                  done

            # 3. Create GitHub Release with ALL artifacts
            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ github.ref_name }}
                  body: |
                      ## Release Notes
                      Automated release created from tag ${{ github.ref_name }}

                      **Published to PyPI:**
                      - `lumen-resources`

                      **Attached Binaries (Manual Install):**
                      - `lumen-clip`
                      - `lumen-face`
                      - `lumen-ocr`

                      ### Installation Guide

                      #### 1. Base Library
                      The core resource manager is available on PyPI:
                      ```bash
                      pip install lumen-resources==${{ env.VERSION }}
                      ```

                      #### 2. Service Installation (from .whl)
                      Download the `.whl` file for the service you need (e.g., `lumen_clip`) from the assets below.

                      **Standard (CPU):**
                      ```bash
                      pip install "./lumen_clip-${{ env.VERSION }}-py3-none-any.whl[cpu]"
                      ```

                      **NVIDIA GPU (CUDA 12.6):**
                      ```bash
                      pip install "./lumen_clip-${{ env.VERSION }}-py3-none-any.whl[cu126]" \
                        --extra-index-url https://download.pytorch.org/whl/cu126
                      ```

                      **Apple Silicon (Mac M1/M2/M3):**
                      ```bash
                      pip install "./lumen_clip-${{ env.VERSION }}-py3-none-any.whl[mps]"
                      ```

                      **Intel OpenVINO:**
                      ```bash
                      pip install "./lumen_clip-${{ env.VERSION }}-py3-none-any.whl[openvino253]"
                      ```

                      **NVIDIA Jetson (JetPack 6):**
                      ```bash
                      pip install "./lumen_clip-${{ env.VERSION }}-py3-none-any.whl[jp61cu126]" \
                        --extra-index-url https://pypi.jetson-ai-lab.io/jp6/cu126
                      ```

                      *Note: Replace `lumen_clip` with `lumen_face` or `lumen_ocr` as needed.*
                  draft: false
                  prerelease: false
                  files: |
                      dist/*.whl
                      dist/*.tar.gz
