name: Release Packages

on:
    push:
        branches: [dev] # 只在 dev 分支触发自动发布
        tags: ["v*"] # tag 触发正式发布

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install build tools
              run: pip install build setuptools_scm

            - name: Get version from root
              id: get_version
              run: |
                  # Get version from project root
                  python -c "
                  import setuptools_scm
                  try:
                      version = setuptools_scm.get_version()
                      print(f'Version found: {version}')
                      with open('version.txt', 'w') as f:
                          f.write(version)
                  except Exception as e:
                      print(f'Error getting version: {e}')
                      with open('version.txt', 'w') as f:
                          f.write('0.0.0')
                  "

                  # Show the version and set environment variable
                  if [ -f version.txt ]; then
                    VERSION=$(cat version.txt)
                    echo "Version determined: $VERSION"
                    echo "VERSION=$VERSION" >> $GITHUB_ENV
                    echo "version=$VERSION" >> $GITHUB_OUTPUT
                  else
                    echo "Failed to determine version"
                    echo "VERSION=0.0.0" >> $GITHUB_ENV
                    echo "version=0.0.0" >> $GITHUB_OUTPUT
                  fi

            - name: Build all packages
              run: |
                  for pkg in lumen-clip lumen-resources lumen-face lumen-ocr; do
                    echo "Building $pkg..."
                    cd $pkg
                    python -m build --outdir ../dist
                    cd ..
                  done

            - name: List built files
              run: ls -la dist/

            # 正式发布 - 使用更现代的 action
            - name: Create Release for Tag
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ github.ref_name }}
                  body: |
                      ## Release Notes
                      Automated release created from tag ${{ github.ref_name }}

                      **Packages included:**
                      - lumen-clip
                      - lumen-resources
                      - lumen-face
                      - lumen-ocr
                  draft: false
                  prerelease: false
                  files: |
                      dist/*.whl
                      dist/*.tar.gz
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # 开发版发布
            - name: Create Dev Release
              if: github.ref == 'refs/heads/dev'
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ env.VERSION }}-dev
                  name: Dev Release ${{ env.VERSION }}
                  body: |
                      ## Development Release
                      Automated development release from dev branch

                      **Version:** ${{ env.VERSION }}
                      **Commit:** ${{ github.sha }}

                      **Packages included:**
                      - lumen-clip
                      - lumen-resources
                      - lumen-face
                      - lumen-ocr
                  draft: false
                  prerelease: true
                  files: |
                      dist/*.whl
                      dist/*.tar.gz
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
