name: Release Packages

on:
    push:
        tags: ["v*"]

jobs:
    release:
        name: Build and Publish
        runs-on: ubuntu-latest
        permissions:
            contents: write # For GitHub Release
            id-token: write # For PyPI

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install uv
              uses: astral-sh/setup-uv@v4
              with:
                  version: "latest"

            - name: Set up Python
              run: uv python install 3.10

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: lumen-app/web-ui/package-lock.json

            - name: Build Web UI
              run: |
                  cd lumen-app/web-ui
                  npm ci
                  npm run build

            - name: Verify Version matches Tag
              run: |
                  cd lumen-resources
                  uv run --with setuptools_scm python -m setuptools_scm
                  cd ..

                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  echo "SETUPTOOLS_SCM_PRETEND_VERSION=$VERSION" >> $GITHUB_ENV
                  echo "SETUPTOOLS_SCM_PRETEND_NAMED=true" >> $GITHUB_ENV

            - name: Build and Publish lumen-resources
              run: |
                  echo "ðŸ“¦ Building lumen-resources..."
                  uv build --package lumen-resources

                  echo "ðŸš€ Publishing to PyPI..."
                  uvx twine upload dist/* --username __token__ --password ${{ secrets.PYPI_API_TOKEN }}

            - name: Clean dist
              run: rm -rf dist/*

            - name: Build and Publish lumen-app
              run: |
                  echo "ðŸ“¦ Building lumen-app..."
                  uv build --package lumen-app

                  echo "ðŸš€ Publishing to PyPI..."
                  uvx twine upload dist/* --username __token__ --password ${{ secrets.PYPI_API_TOKEN }}

            - name: Clean dist
              run: rm -rf dist/*

            - name: Build Service Packages
              run: |
                  for pkg in lumen-clip lumen-face lumen-ocr lumen-vlm; do
                    echo "ðŸ“¦ Building $pkg..."
                    uv build --package $pkg
                  done

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
                  name: Release ${{ github.ref_name }}
                  files: dist/*
                  body: |
                      ## Release Notes
                      Automated release created from tag ${{ github.ref_name }}

                      **Published to PyPI:**
                      - `lumen-resources`
                      - `lumen-app` (includes Web UI)

                      **Attached Binaries:**
                      - `lumen-clip`
                      - `lumen-face`
                      - `lumen-ocr`
                      - `lumen-vlm`

                      ### Installation Guide

                      #### 1. Base Library & Web UI
                      The core resource manager and web application are available on PyPI:
                      ```bash
                      pip install lumen-resources==${{ env.VERSION }}
                      pip install lumen-app==${{ env.VERSION }}
                      ```

                      **Web UI Commands:**
                      - `lumen --config <path>` - Start gRPC hub server
                      - `lumen-webui --port 8000` - Start Web UI + API server

                      #### 2. Service Installation (from .whl)
                      Download the `.whl` file for the service you need (e.g., `lumen_clip`) from the assets below.

                      **Standard (CPU):**
                      ```bash
                      pip install "./lumen_clip-${{ env.VERSION }}-py3-none-any.whl[cpu]"
                      ```

                      **NVIDIA GPU (CUDA 12.6):**
                      ```bash
                      pip install "./lumen_clip-${{ env.VERSION }}-py3-none-any.whl[cuda]"
                      ```

                      **NVIDIA GPU with PyTorch CUDA wheels:**
                      ```bash
                      pip install "./lumen_clip-${{ env.VERSION }}-py3-none-any.whl[cuda]" \
                      --index-url https://download.pytorch.org/whl/cu126
                      ```

                      **Apple Silicon (Mac M Series):**
                      ```bash
                      pip install "./lumen_clip-${{ env.VERSION }}-py3-none-any.whl[apple]"
                      ```

                      **Intel OpenVINO:**
                      ```bash
                      pip install "./lumen_clip-${{ env.VERSION }}-py3-none-any.whl[openvino]"
                      ```

                      **NVIDIA Jetson (JetPack 6 with CUDA 12.6):**
                      ```bash
                      pip install "./lumen_clip-${{ env.VERSION }}-py3-none-any.whl[cuda]" \
                      --extra-index-url https://pypi.jetson-ai-lab.io/jp6/cu126
                      ```

                      **Rockchip NPU:**
                      ```bash
                      pip install "./lumen_clip-${{ env.VERSION }}-py3-none-any.whl[rknn]"
                      ```

                      **PyTorch:**
                      ```bash
                      pip install "./lumen_clip-${{ env.VERSION }}-py3-none-any.whl[torch]"
                      ```
