name: Release Packages

on:
    push:
        branches: [main, dev]
        tags: ["v*"]

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install build tools
              run: pip install build setuptools_scm

            - name: Build all packages
              run: |
                  for pkg in lumen-clip lumen-resources lumen-face lumen-ocr; do
                    echo "Building $pkg..."
                    cd $pkg
                    python -m build --outdir ../dist
                    cd ..
                  done

            - name: Create Release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  if [[ $GITHUB_REF == refs/tags/* ]]; then
                    TAG=${GITHUB_REF#refs/tags/}
                    gh release create $TAG --title "Release $TAG" --generate-notes dist/*.whl
                  elif [[ $GITHUB_REF == refs/heads/dev ]]; then
                    # Get version from one of the subpackages using setuptools_scm
                    cd lumen-clip && python -c "import setuptools_scm; print(setuptools_scm.get_version())" > ../version.txt && cd ..
                    VERSION=$(cat version.txt)
                    gh release create "v$VERSION-dev" --title "Dev Release $VERSION" --prerelease --generate-notes dist/*.whl
                  fi
